<script>
  fetch("https://epg.tvmalaysia.workers.dev/?channel=104.astro")
    .then(res => res.json())
    .then(data => {
      const epgBox = document.getElementById("epg-astro-ria");

      const now = new Date();
      const msiaNow = new Date(now.getTime() + (8 * 60 * 60 * 1000)); // UTC+8

      const filtered = data.filter(item => {
        const y = item.start.slice(0, 4);
        const m = item.start.slice(4, 6);
        const d = item.start.slice(6, 8);
        const H = item.start.slice(8, 10);
        const M = item.start.slice(10, 12);
        const epgDate = new Date(`${y}-${m}-${d}T${H}:${M}:00+08:00`);
        return epgDate >= msiaNow;
      });

      if (filtered.length === 0) {
        epgBox.innerHTML = "<p>Tiada rancangan akan datang untuk hari ini.</p>";
        return;
      }

      const html = filtered.map(item => {
        const rawTime = item.start.slice(8, 12); // "1900"
        const hour = parseInt(rawTime.slice(0, 2));
        const minute = rawTime.slice(2, 4);
        const ampm = hour >= 12 ? 'PM' : 'AM';
        const hour12 = hour % 12 === 0 ? 12 : hour % 12;
        const formattedTime = `${hour12}:${minute} ${ampm}`;

        return `
          <div class="epg-item">
            <strong>${formattedTime}</strong> - ${item.title}
            <small>${item.desc}</small>
          </div>
        `;
      }).join('');

      epgBox.innerHTML = `<h3>ðŸ“º Jadual Astro Ria (Terkini & Akan Datang Hari Ini)</h3>${html}`;
    })
    .catch(error => {
      console.error("EPG Fetch Error:", error);
      document.getElementById("epg-astro-ria").innerHTML = "<p>Gagal memuatkan jadual rancangan.</p>";
    });
</script>
